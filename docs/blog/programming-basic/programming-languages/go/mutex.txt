3:I[9275,[],""]
5:I[1343,[],""]
6:I[8700,["231","static/chunks/231-42eeaa612179830e.js","113","static/chunks/113-8a0c0daa2bfc088c.js","185","static/chunks/app/layout-a7a2551425c87cc3.js"],"ThemeProviders"]
7:I[4080,["231","static/chunks/231-42eeaa612179830e.js","113","static/chunks/113-8a0c0daa2bfc088c.js","185","static/chunks/app/layout-a7a2551425c87cc3.js"],""]
8:I[9032,["231","static/chunks/231-42eeaa612179830e.js","113","static/chunks/113-8a0c0daa2bfc088c.js","185","static/chunks/app/layout-a7a2551425c87cc3.js"],"KBarSearchProvider"]
9:I[231,["231","static/chunks/231-42eeaa612179830e.js","173","static/chunks/173-af5b99c330035292.js","459","static/chunks/459-6c5dcdc51f43b997.js","797","static/chunks/app/blog/%5B...slug%5D/page-5ad4d86948f7f0f4.js"],""]
a:I[509,["231","static/chunks/231-42eeaa612179830e.js","113","static/chunks/113-8a0c0daa2bfc088c.js","185","static/chunks/app/layout-a7a2551425c87cc3.js"],"KBarButton"]
b:I[1398,["231","static/chunks/231-42eeaa612179830e.js","113","static/chunks/113-8a0c0daa2bfc088c.js","185","static/chunks/app/layout-a7a2551425c87cc3.js"],"default"]
c:I[8976,["231","static/chunks/231-42eeaa612179830e.js","113","static/chunks/113-8a0c0daa2bfc088c.js","185","static/chunks/app/layout-a7a2551425c87cc3.js"],"default"]
4:["slug","programming-basic/programming-languages/go/mutex","c"]
0:["gPZ8ET5SZwyuIVWxpISNr",[[["",{"children":["blog",{"children":[["slug","programming-basic/programming-languages/go/mutex","c"],{"children":["__PAGE__?{\"slug\":[\"programming-basic\",\"programming-languages\",\"go\",\"mutex\"]}",{}]}]}]},"$undefined","$undefined",true],["",{"children":["blog",{"children":[["slug","programming-basic/programming-languages/go/mutex","c"],{"children":["__PAGE__",{},[["$L1","$L2"],null],null]},["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children","$4","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/e36d2c8a31781d2e.css","precedence":"next","crossOrigin":"$undefined"}]]}],null]},["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children","blog","children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":"$undefined","notFoundStyles":"$undefined","styles":null}],null]},[["$","html",null,{"lang":"en-us","className":"__variable_0aa4ae scroll-smooth","suppressHydrationWarning":true,"children":[["$","link",null,{"rel":"apple-touch-icon","sizes":"76x76","href":"/static/favicons/logo-round.png"}],["$","link",null,{"rel":"icon","type":"image/png","sizes":"32x32","href":"/static/favicons/logo-round.png"}],["$","link",null,{"rel":"icon","type":"image/png","sizes":"16x16","href":"/static/favicons/logo-round.png"}],["$","link",null,{"rel":"manifest","href":"/static/favicons/site.webmanifest"}],["$","meta",null,{"name":"msapplication-TileColor","content":"#000000"}],["$","meta",null,{"name":"theme-color","media":"(prefers-color-scheme: light)","content":"#fff"}],["$","meta",null,{"name":"theme-color","media":"(prefers-color-scheme: dark)","content":"#000"}],["$","link",null,{"rel":"alternate","type":"application/rss+xml","href":"/feed.xml"}],["$","body",null,{"className":"bg-white pl-[calc(100vw-100%)] text-black antialiased dark:bg-gray-950 dark:text-white","children":["$","$L6",null,{"children":[["$undefined","$undefined","$undefined",["$","$L7",null,{"async":true,"defer":true,"data-website-id":"$undefined","src":"https://analytics.umami.is/script.js"}],"$undefined","$undefined"],["$","section",null,{"className":"mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0","children":[["$","$L8",null,{"kbarConfig":{"searchDocumentsPath":"/search.json"},"children":[["$","header",null,{"className":"flex items-center w-full bg-white dark:bg-gray-950 justify-between py-10","children":[["$","$L9",null,{"className":"break-words","href":"/","aria-label":"CodeWisdom","children":["$","div",null,{"className":"flex items-center justify-between","children":[["$","div",null,{"className":"mr-3","children":["$","img",null,{"src":"/_next/static/media/logo.a3d92d8f.png","alt":"logo","className":"h-10 w-14"}]}],["$","div",null,{"className":"hidden h-6 text-2xl font-semibold sm:block","children":"CodeWisdom"}]]}]}],["$","div",null,{"className":"flex items-center space-x-4 leading-5 sm:space-x-6","children":[["$","div",null,{"className":"no-scrollbar hidden max-w-40 items-center space-x-4 overflow-x-auto sm:flex sm:space-x-6 md:max-w-72 lg:max-w-96","children":[["$","$L9",null,{"className":"block font-medium text-gray-900 hover:text-primary-500 dark:text-gray-100 dark:hover:text-primary-400","href":"/blog","children":"Blog"}],["$","$L9",null,{"className":"block font-medium text-gray-900 hover:text-primary-500 dark:text-gray-100 dark:hover:text-primary-400","href":"/tags","children":"Tags"}],["$","$L9",null,{"className":"block font-medium text-gray-900 hover:text-primary-500 dark:text-gray-100 dark:hover:text-primary-400","href":"/projects","children":"Projects"}],["$","$L9",null,{"className":"block font-medium text-gray-900 hover:text-primary-500 dark:text-gray-100 dark:hover:text-primary-400","href":"/about","children":"About"}]]}],["$","$La",null,{"aria-label":"Search","children":["$","svg",null,{"xmlns":"http://www.w3.org/2000/svg","fill":"none","viewBox":"0 0 24 24","strokeWidth":1.5,"stroke":"currentColor","className":"h-6 w-6 text-gray-900 hover:text-primary-500 dark:text-gray-100 dark:hover:text-primary-400","children":["$","path",null,{"strokeLinecap":"round","strokeLinejoin":"round","d":"M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"}]}]}],["$","$Lb",null,{}],["$","$Lc",null,{}]]}]]}],["$","main",null,{"className":"mb-auto","children":["$","$L3",null,{"parallelRouterKey":"children","segmentPath":["children"],"error":"$undefined","errorStyles":"$undefined","errorScripts":"$undefined","template":["$","$L5",null,{}],"templateStyles":"$undefined","templateScripts":"$undefined","notFound":["$","div",null,{"className":"flex flex-col items-start justify-start md:mt-24 md:flex-row md:items-center md:justify-center md:space-x-6","children":[["$","div",null,{"className":"space-x-2 pb-8 pt-6 md:space-y-5","children":["$","h1",null,{"className":"text-6xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 md:border-r-2 md:px-6 md:text-8xl md:leading-14","children":"404"}]}],["$","div",null,{"className":"max-w-md","children":[["$","p",null,{"className":"mb-4 text-xl font-bold leading-normal md:text-2xl","children":"Sorry we couldn't find this page."}],["$","p",null,{"className":"mb-8","children":"But dont worry, you can find plenty of other things on our homepage."}],["$","$L9",null,{"className":"focus:shadow-outline-blue inline rounded-lg border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium leading-5 text-white shadow transition-colors duration-150 hover:bg-blue-700 focus:outline-none dark:hover:bg-blue-500","href":"/","children":"Back to homepage"}]]}]]}],"notFoundStyles":[],"styles":null}]}]]}],["$","footer",null,{"children":["$","div",null,{"className":"mt-16 flex flex-col items-center","children":["$","div",null,{"className":"mb-2 flex space-x-2 text-sm text-gray-500 dark:text-gray-400","children":[["$","div",null,{"children":"Bowen Y"}],["$","div",null,{"children":" • "}],["$","div",null,{"children":"© 2024"}],["$","div",null,{"children":" • "}],["$","$L9",null,{"className":"break-words","href":"/","children":"CodeWisdom"}]]}]}]}]]}]]}]}]]}],null],null],[[["$","link","0",{"rel":"stylesheet","href":"/_next/static/css/5beba742ae93b864.css","precedence":"next","crossOrigin":"$undefined"}],["$","link","1",{"rel":"stylesheet","href":"/_next/static/css/f719ff1083adf929.css","precedence":"next","crossOrigin":"$undefined"}]],"$Ld"]]]]
e:I[4347,["231","static/chunks/231-42eeaa612179830e.js","173","static/chunks/173-af5b99c330035292.js","459","static/chunks/459-6c5dcdc51f43b997.js","797","static/chunks/app/blog/%5B...slug%5D/page-5ad4d86948f7f0f4.js"],"default"]
f:I[8173,["231","static/chunks/231-42eeaa612179830e.js","173","static/chunks/173-af5b99c330035292.js","459","static/chunks/459-6c5dcdc51f43b997.js","797","static/chunks/app/blog/%5B...slug%5D/page-5ad4d86948f7f0f4.js"],"Image"]
10:I[408,["231","static/chunks/231-42eeaa612179830e.js","173","static/chunks/173-af5b99c330035292.js","459","static/chunks/459-6c5dcdc51f43b997.js","797","static/chunks/app/blog/%5B...slug%5D/page-5ad4d86948f7f0f4.js"],"default"]
2:[["$","script",null,{"type":"application/ld+json","dangerouslySetInnerHTML":{"__html":"{\"@context\":\"https://schema.org\",\"@type\":\"BlogPosting\",\"headline\":\"Mutex in Go\",\"datePublished\":\"2024-10-31T00:00:00.000Z\",\"dateModified\":\"2024-10-31T00:00:00.000Z\",\"description\":\"Explores the mutex in Go.\",\"image\":\"/static/images/logo-round.png\",\"url\":\"https://codewisdom.io/blog/programming-basic/programming-languages/go/mutex\",\"author\":[{\"@type\":\"Person\",\"name\":\"Bowen Y\"}]}"}}],["$","section",null,{"className":"mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0","children":[["$","$Le",null,{}],["$","article",null,{"children":["$","div",null,{"className":"xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700","children":[["$","header",null,{"className":"pt-6 xl:pb-6","children":["$","div",null,{"className":"space-y-1 text-center","children":[["$","dl",null,{"className":"space-y-10","children":["$","div",null,{"children":[["$","dt",null,{"className":"sr-only","children":"Published on"}],["$","dd",null,{"className":"text-base font-medium leading-6 text-gray-500 dark:text-gray-400","children":["$","time",null,{"dateTime":"2024-10-31T00:00:00.000Z","children":"Wednesday, October 30, 2024"}]}]]}]}],["$","div",null,{"children":["$","h1",null,{"className":"text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14","children":"Mutex in Go"}]}]]}]}],["$","div",null,{"className":"grid-rows-[auto_1fr] divide-y divide-gray-200 pb-8 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6 xl:divide-y-0","children":[["$","dl",null,{"className":"pb-10 pt-6 xl:border-b xl:border-gray-200 xl:pt-11 xl:dark:border-gray-700","children":[["$","dt",null,{"className":"sr-only","children":"Authors"}],["$","dd",null,{"children":["$","ul",null,{"className":"flex flex-wrap justify-center gap-4 sm:space-x-12 xl:block xl:space-x-0 xl:space-y-8","children":[["$","li","Bowen Y",{"className":"flex items-center space-x-2","children":[["$","$Lf",null,{"src":"/static/images/pixel-avatar.png","width":38,"height":38,"alt":"avatar","className":"h-10 w-10 rounded-full"}],["$","dl",null,{"className":"whitespace-nowrap text-sm font-medium leading-5","children":[["$","dt",null,{"className":"sr-only","children":"Name"}],["$","dd",null,{"className":"text-gray-900 dark:text-gray-100","children":"Bowen Y"}],["$","dt",null,{"className":"sr-only","children":"Twitter"}],["$","dd",null,{"children":"$undefined"}]]}]]}]]}]}]]}],["$","div",null,{"className":"divide-y divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0","children":["$","div",null,{"className":"prose max-w-none pb-8 pt-10 dark:prose-invert","children":[["$","h2",null,{"className":"content-header","id":"go-mutex","children":[["$","a",null,{"className":"break-words","href":"#go-mutex","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"Go Mutex"]}],["$","h3",null,{"className":"content-header","id":"1-overview-of-gos-syncmutex","children":[["$","a",null,{"className":"break-words","href":"#1-overview-of-gos-syncmutex","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"1. Overview of Go's ",["$","code",null,{"children":"sync.Mutex"}]]}],["$","p",null,{"children":["Go's ",["$","code",null,{"children":"sync.Mutex"}]," is implemented in a way that it avoids system calls whenever possible by trying to handle mutexes in user space. However, it can fall back to system-level operations like kernel threads or sleeping/waking up threads when necessary."]}],["$","p",null,{"children":["Here's how the code behaves at the runtime level when you call ",["$","code",null,{"children":"mutex.Lock()"}],"."]}],["$","h3",null,{"className":"content-header","id":"2-definition-of-syncmutex","children":[["$","a",null,{"className":"break-words","href":"#2-definition-of-syncmutex","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"2. ",["$","strong",null,{"children":["Definition of ",["$","code",null,{"children":"sync.Mutex"}]]}]]}],["$","p",null,{"children":["In Go, the ",["$","code",null,{"children":"sync.Mutex"}]," is defined like this (simplified):"]}],["$","$L10",null,{"className":"language-go","children":["$","code",null,{"className":"language-go code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"type"}]," Mutex ",["$","span",null,{"className":"token keyword","children":"struct"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    state ",["$","span",null,{"className":"token builtin","children":"int32"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    sema  ",["$","span",null,{"className":"token builtin","children":"uint32"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],["$","ul",null,{"children":[["$","li",null,{"children":["The ",["$","code",null,{"children":"state"}]," field is a combination of flags that indicate whether the mutex is locked or unlocked and whether other goroutines are waiting."]}],["$","li",null,{"children":["The ",["$","code",null,{"children":"sema"}]," field is used to coordinate sleeping/waking of goroutines."]}]]}],["$","$L10",null,{"className":"language-go","children":["$","code",null,{"className":"language-go code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"const"}]," ",["$","span",null,{"className":"token punctuation","children":"("}],"\n"]}],["$","span",null,{"className":"code-line","children":["\tmutexLocked ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token number","children":"1"}]," ",["$","span",null,{"className":"token operator","children":"<<"}]," ",["$","span",null,{"className":"token boolean","children":"iota"}]," ",["$","span",null,{"className":"token comment","children":"// mutex is locked"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\tmutexWoken\n"}],["$","span",null,{"className":"code-line","children":"\tmutexStarving\n"}],["$","span",null,{"className":"code-line","children":["\tmutexWaiterShift ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token boolean","children":"iota"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// Mutex fairness."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"//"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// Mutex can be in 2 modes of operations: normal and starvation."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// In normal mode waiters are queued in FIFO order, but a woken up waiter"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// does not own the mutex and competes with new arriving goroutines over"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// the ownership. New arriving goroutines have an advantage -- they are"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// already running on CPU and there can be lots of them, so a woken up"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// waiter has good chances of losing. In such case it is queued at front"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// of the wait queue. If a waiter fails to acquire the mutex for more than 1ms,"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// it switches mutex to the starvation mode."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"//"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// In starvation mode ownership of the mutex is directly handed off from"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// the unlocking goroutine to the waiter at the front of the queue."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// New arriving goroutines don't try to acquire the mutex even if it appears"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// to be unlocked, and don't try to spin. Instead they queue themselves at"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// the tail of the wait queue."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"//"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// If a waiter receives ownership of the mutex and sees that either"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// (1) it is the last waiter in the queue, or (2) it waited for less than 1 ms,"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// it switches mutex back to normal operation mode."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"//"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// Normal mode has considerably better performance as a goroutine can acquire"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// a mutex several times in a row even if there are blocked waiters."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// Starvation mode is important to prevent pathological cases of tail latency."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\tstarvationThresholdNs ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token number","children":"1e6"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}]]}]}],["$","h3",null,{"className":"content-header","id":"3-lock-implementation-mutexlock","children":[["$","a",null,{"className":"break-words","href":"#3-lock-implementation-mutexlock","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"3. ",["$","strong",null,{"children":["Lock Implementation (",["$","code",null,{"children":"mutex.Lock()"}],")"]}]]}],["$","p",null,{"children":["The ",["$","code",null,{"children":"Lock()"}]," function works by manipulating the ",["$","code",null,{"children":"state"}]," of the mutex. Here’s the high-level Go code:"]}],["$","$L10",null,{"className":"language-go","children":["$","code",null,{"className":"language-go code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token comment","children":"// Lock locks m."}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token comment","children":"// If the lock is already in use, the calling goroutine"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token comment","children":"// blocks until the mutex is available."}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"func"}]," ",["$","span",null,{"className":"token punctuation","children":"("}],"m ",["$","span",null,{"className":"token operator","children":"*"}],"Mutex",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token function","children":"Lock"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// Fast path: grab unlocked mutex."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token keyword","children":"if"}]," atomic",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"CompareAndSwapInt32"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"state",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token number","children":"0"}],["$","span",null,{"className":"token punctuation","children":","}]," mutexLocked",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," race",["$","span",null,{"className":"token punctuation","children":"."}],"Enabled ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\trace",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"Acquire"}],["$","span",null,{"className":"token punctuation","children":"("}],"unsafe",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"Pointer"}],["$","span",null,{"className":"token punctuation","children":"("}],"m",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token keyword","children":"return"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// Slow path (outlined so that the fast path can be inlined)"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\tm",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"lockSlow"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],["$","h3",null,{"className":"content-header","id":"4-fast-path-user-space-locking","children":[["$","a",null,{"className":"break-words","href":"#4-fast-path-user-space-locking","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"4. ",["$","strong",null,{"children":"Fast Path (User-Space Locking)"}]]}],["$","p",null,{"children":["Go first tries the ",["$","strong",null,{"children":"fast path"}],", where it attempts to acquire the lock using an atomic operation. In this case, ",["$","code",null,{"children":"atomic.CompareAndSwapInt32()"}]," (CAS) is used to check if the mutex is unlocked (",["$","code",null,{"children":"m.state == 0"}],") and, if so, it sets the lock by updating the state."]}],["$","ul",null,{"children":["$","li",null,{"children":[["$","strong",null,{"children":"Compare-and-Swap (CAS)"}],": This is an atomic instruction provided by the CPU, which checks whether the value of ",["$","code",null,{"children":"m.state"}]," is ",["$","code",null,{"children":"0"}]," (unlocked) and swaps it to ",["$","code",null,{"children":"1"}]," (locked). If successful, the function returns immediately, and the lock is acquired without any system calls or blocking."]}]}],["$","$L10",null,{"className":"language-go","children":["$","code",null,{"className":"language-go code-highlight","children":["$","span",null,{"className":"code-line","children":["atomic",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"CompareAndSwapInt32"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"state",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token number","children":"0"}],["$","span",null,{"className":"token punctuation","children":","}]," mutexLocked",["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}]}]}],["$","p",null,{"children":"If the CAS operation is successful, the lock is acquired, and no kernel intervention is required. This is fast because it doesn't involve the OS and remains in user space."}],["$","h3",null,{"className":"content-header","id":"5-slow-path-contention-handling","children":[["$","a",null,{"className":"break-words","href":"#5-slow-path-contention-handling","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"5. ",["$","strong",null,{"children":"Slow Path (Contention Handling)"}]]}],["$","p",null,{"children":["If the fast path fails (meaning another goroutine already holds the lock), the code enters the ",["$","strong",null,{"children":"slow path"}]," (",["$","code",null,{"children":"m.lockSlow()"}],"), which handles contention between multiple goroutines trying to acquire the lock."]}],["$","$L10",null,{"className":"language-go","children":["$","code",null,{"className":"language-go code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"func"}]," ",["$","span",null,{"className":"token punctuation","children":"("}],"m ",["$","span",null,{"className":"token operator","children":"*"}],"Mutex",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token function","children":"lockSlow"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token keyword","children":"var"}]," waitStartTime ",["$","span",null,{"className":"token builtin","children":"int64"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\tstarving ",["$","span",null,{"className":"token operator","children":":="}]," ",["$","span",null,{"className":"token boolean","children":"false"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\tawoke ",["$","span",null,{"className":"token operator","children":":="}]," ",["$","span",null,{"className":"token boolean","children":"false"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\titer ",["$","span",null,{"className":"token operator","children":":="}]," ",["$","span",null,{"className":"token number","children":"0"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\told ",["$","span",null,{"className":"token operator","children":":="}]," m",["$","span",null,{"className":"token punctuation","children":"."}],"state\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token keyword","children":"for"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// Don't spin in starvation mode, ownership is handed off to waiters"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// so we won't be able to acquire the mutex anyway."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," old",["$","span",null,{"className":"token operator","children":"&"}],["$","span",null,{"className":"token punctuation","children":"("}],"mutexLocked",["$","span",null,{"className":"token operator","children":"|"}],"mutexStarving",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"=="}]," mutexLocked ",["$","span",null,{"className":"token operator","children":"&&"}]," ",["$","span",null,{"className":"token function","children":"runtime_canSpin"}],["$","span",null,{"className":"token punctuation","children":"("}],"iter",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token comment","children":"// Active spinning makes sense."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token comment","children":"// Try to set mutexWoken flag to inform Unlock"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token comment","children":"// to not wake other blocked goroutines."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," ",["$","span",null,{"className":"token operator","children":"!"}],"awoke ",["$","span",null,{"className":"token operator","children":"&&"}]," old",["$","span",null,{"className":"token operator","children":"&"}],"mutexWoken ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token operator","children":"&&"}]," old",["$","span",null,{"className":"token operator","children":">>"}],"mutexWaiterShift ",["$","span",null,{"className":"token operator","children":"!="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token operator","children":"&&"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\tatomic",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"CompareAndSwapInt32"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"state",["$","span",null,{"className":"token punctuation","children":","}]," old",["$","span",null,{"className":"token punctuation","children":","}]," old",["$","span",null,{"className":"token operator","children":"|"}],"mutexWoken",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\tawoke ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token boolean","children":"true"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token function","children":"runtime_doSpin"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\titer",["$","span",null,{"className":"token operator","children":"++"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\told ",["$","span",null,{"className":"token operator","children":"="}]," m",["$","span",null,{"className":"token punctuation","children":"."}],"state\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token keyword","children":"continue"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token builtin","children":"new"}]," ",["$","span",null,{"className":"token operator","children":":="}]," old\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// Don't try to acquire starving mutex, new arriving goroutines must queue."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," old",["$","span",null,{"className":"token operator","children":"&"}],"mutexStarving ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token builtin","children":"new"}]," ",["$","span",null,{"className":"token operator","children":"|="}]," mutexLocked\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," old",["$","span",null,{"className":"token operator","children":"&"}],["$","span",null,{"className":"token punctuation","children":"("}],"mutexLocked",["$","span",null,{"className":"token operator","children":"|"}],"mutexStarving",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"!="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token builtin","children":"new"}]," ",["$","span",null,{"className":"token operator","children":"+="}]," ",["$","span",null,{"className":"token number","children":"1"}]," ",["$","span",null,{"className":"token operator","children":"<<"}]," mutexWaiterShift\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// The current goroutine switches mutex to starvation mode."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// But if the mutex is currently unlocked, don't do the switch."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// Unlock expects that starving mutex has waiters, which will not"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// be true in this case."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," starving ",["$","span",null,{"className":"token operator","children":"&&"}]," old",["$","span",null,{"className":"token operator","children":"&"}],"mutexLocked ",["$","span",null,{"className":"token operator","children":"!="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token builtin","children":"new"}]," ",["$","span",null,{"className":"token operator","children":"|="}]," mutexStarving\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," awoke ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token comment","children":"// The goroutine has been woken from sleep,"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token comment","children":"// so we need to reset the flag in either case."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," ",["$","span",null,{"className":"token builtin","children":"new"}],["$","span",null,{"className":"token operator","children":"&"}],"mutexWoken ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token function","children":"throw"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"sync: inconsistent mutex state\""}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token builtin","children":"new"}]," ",["$","span",null,{"className":"token operator","children":"&^="}]," mutexWoken\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," atomic",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"CompareAndSwapInt32"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"state",["$","span",null,{"className":"token punctuation","children":","}]," old",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token builtin","children":"new"}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," old",["$","span",null,{"className":"token operator","children":"&"}],["$","span",null,{"className":"token punctuation","children":"("}],"mutexLocked",["$","span",null,{"className":"token operator","children":"|"}],"mutexStarving",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token keyword","children":"break"}]," ",["$","span",null,{"className":"token comment","children":"// locked the mutex with CAS"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token comment","children":"// If we were already waiting before, queue at the front of the queue."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\tqueueLifo ",["$","span",null,{"className":"token operator","children":":="}]," waitStartTime ",["$","span",null,{"className":"token operator","children":"!="}]," ",["$","span",null,{"className":"token number","children":"0"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," waitStartTime ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\twaitStartTime ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token function","children":"runtime_nanotime"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token function","children":"runtime_SemacquireMutex"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"sema",["$","span",null,{"className":"token punctuation","children":","}]," queueLifo",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token number","children":"1"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\tstarving ",["$","span",null,{"className":"token operator","children":"="}]," starving ",["$","span",null,{"className":"token operator","children":"||"}]," ",["$","span",null,{"className":"token function","children":"runtime_nanotime"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token operator","children":"-"}],"waitStartTime ",["$","span",null,{"className":"token operator","children":">"}]," starvationThresholdNs\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\told ",["$","span",null,{"className":"token operator","children":"="}]," m",["$","span",null,{"className":"token punctuation","children":"."}],"state\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," old",["$","span",null,{"className":"token operator","children":"&"}],"mutexStarving ",["$","span",null,{"className":"token operator","children":"!="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token comment","children":"// If this goroutine was woken and mutex is in starvation mode,"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token comment","children":"// ownership was handed off to us but mutex is in somewhat"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token comment","children":"// inconsistent state: mutexLocked is not set and we are still"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token comment","children":"// accounted as waiter. Fix that."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," old",["$","span",null,{"className":"token operator","children":"&"}],["$","span",null,{"className":"token punctuation","children":"("}],"mutexLocked",["$","span",null,{"className":"token operator","children":"|"}],"mutexWoken",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"!="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token operator","children":"||"}]," old",["$","span",null,{"className":"token operator","children":">>"}],"mutexWaiterShift ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t\t",["$","span",null,{"className":"token function","children":"throw"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"sync: inconsistent mutex state\""}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\tdelta ",["$","span",null,{"className":"token operator","children":":="}]," ",["$","span",null,{"className":"token function","children":"int32"}],["$","span",null,{"className":"token punctuation","children":"("}],"mutexLocked ",["$","span",null,{"className":"token operator","children":"-"}]," ",["$","span",null,{"className":"token number","children":"1"}],["$","span",null,{"className":"token operator","children":"<<"}],"mutexWaiterShift",["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," ",["$","span",null,{"className":"token operator","children":"!"}],"starving ",["$","span",null,{"className":"token operator","children":"||"}]," old",["$","span",null,{"className":"token operator","children":">>"}],"mutexWaiterShift ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"1"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t\t",["$","span",null,{"className":"token comment","children":"// Exit starvation mode."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t\t",["$","span",null,{"className":"token comment","children":"// Critical to do it here and consider wait time."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t\t",["$","span",null,{"className":"token comment","children":"// Starvation mode is so inefficient, that two goroutines"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t\t",["$","span",null,{"className":"token comment","children":"// can go lock-step infinitely once they switch mutex"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t\t",["$","span",null,{"className":"token comment","children":"// to starvation mode."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t\tdelta ",["$","span",null,{"className":"token operator","children":"-="}]," mutexStarving\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\tatomic",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"AddInt32"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"state",["$","span",null,{"className":"token punctuation","children":","}]," delta",["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token keyword","children":"break"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\tawoke ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token boolean","children":"true"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\titer ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token number","children":"0"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token punctuation","children":"}"}]," ",["$","span",null,{"className":"token keyword","children":"else"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\told ",["$","span",null,{"className":"token operator","children":"="}]," m",["$","span",null,{"className":"token punctuation","children":"."}],"state\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token keyword","children":"if"}]," race",["$","span",null,{"className":"token punctuation","children":"."}],"Enabled ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\trace",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"Acquire"}],["$","span",null,{"className":"token punctuation","children":"("}],"unsafe",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"Pointer"}],["$","span",null,{"className":"token punctuation","children":"("}],"m",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],["$","ul",null,{"children":["$","li",null,{"children":[["$","strong",null,{"children":"runtime_SemacquireMutex()"}],": If another goroutine holds the lock, Go’s runtime will call this function to put the current goroutine to sleep. It uses the ",["$","code",null,{"children":"sema"}]," field to handle semaphore-like synchronization. When the mutex is unlocked, the waiting goroutine will be woken up and will retry acquiring the lock."]}]}],["$","p",null,{"children":"In this slow path, the thread will either spin (check again if the lock becomes available) or sleep, depending on the circumstances."}],["$","h4",null,{"className":"content-header","id":"detailed-walkthrough-of-the-code","children":[["$","a",null,{"className":"break-words","href":"#detailed-walkthrough-of-the-code","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"Detailed Walkthrough of the Code:"]}],["$","$L10",null,{"className":"language-go","children":["$","code",null,{"className":"language-go code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"if"}]," old",["$","span",null,{"className":"token operator","children":"&"}],["$","span",null,{"className":"token punctuation","children":"("}],"mutexLocked",["$","span",null,{"className":"token operator","children":"|"}],"mutexStarving",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"=="}]," mutexLocked ",["$","span",null,{"className":"token operator","children":"&&"}]," ",["$","span",null,{"className":"token function","children":"runtime_canSpin"}],["$","span",null,{"className":"token punctuation","children":"("}],"iter",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token comment","children":"// Spinning: actively retry to acquire the lock."}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token keyword","children":"if"}]," ",["$","span",null,{"className":"token operator","children":"!"}],"awoke ",["$","span",null,{"className":"token operator","children":"&&"}]," old",["$","span",null,{"className":"token operator","children":"&"}],"mutexWoken ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token operator","children":"&&"}]," old",["$","span",null,{"className":"token operator","children":">>"}],"mutexWaiterShift ",["$","span",null,{"className":"token operator","children":"!="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token operator","children":"&&"}],"\n"]}],["$","span",null,{"className":"code-line","children":["        atomic",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"CompareAndSwapInt32"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"state",["$","span",null,{"className":"token punctuation","children":","}]," old",["$","span",null,{"className":"token punctuation","children":","}]," old",["$","span",null,{"className":"token operator","children":"|"}],"mutexWoken",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["        awoke ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token boolean","children":"true"}]," ",["$","span",null,{"className":"token comment","children":"// Mark as awake to prevent unnecessary wakes."}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token function","children":"runtime_doSpin"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token comment","children":"// Do the actual spin."}],"\n"]}],["$","span",null,{"className":"code-line","children":["    iter",["$","span",null,{"className":"token operator","children":"++"}]," ",["$","span",null,{"className":"token comment","children":"// Keep track of spinning attempts."}],"\n"]}],["$","span",null,{"className":"code-line","children":["    old ",["$","span",null,{"className":"token operator","children":"="}]," m",["$","span",null,{"className":"token punctuation","children":"."}],"state ",["$","span",null,{"className":"token comment","children":"// Update to the latest state."}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token keyword","children":"continue"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}]]}]}],["$","ul",null,{"children":["$","li",null,{"children":[["$","strong",null,{"children":"Active Spinning"}],": If the mutex is locked but not in starvation mode, and spinning is allowed, the goroutine will spin in an attempt to acquire the lock. If the lock isn’t available after multiple spins, the goroutine gives up spinning and prepares to sleep."]}]}],["$","$L10",null,{"className":"language-go","children":["$","code",null,{"className":"language-go code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"if"}]," starving ",["$","span",null,{"className":"token operator","children":"&&"}]," old",["$","span",null,{"className":"token operator","children":"&"}],"mutexLocked ",["$","span",null,{"className":"token operator","children":"!="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token builtin","children":"new"}]," ",["$","span",null,{"className":"token operator","children":"|="}]," mutexStarving ",["$","span",null,{"className":"token comment","children":"// Switch to starvation mode if needed."}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}]]}]}],["$","ul",null,{"children":["$","li",null,{"children":[["$","strong",null,{"children":"Starvation Mode"}],": If the goroutine has been waiting for too long, the mutex switches to starvation mode. This prioritizes existing waiters over newly arriving goroutines, ensuring fairness."]}]}],["$","$L10",null,{"className":"language-go","children":["$","code",null,{"className":"language-go code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"if"}]," atomic",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"CompareAndSwapInt32"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"state",["$","span",null,{"className":"token punctuation","children":","}]," old",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token builtin","children":"new"}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token keyword","children":"if"}]," old",["$","span",null,{"className":"token operator","children":"&"}],["$","span",null,{"className":"token punctuation","children":"("}],"mutexLocked",["$","span",null,{"className":"token operator","children":"|"}],"mutexStarving",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["        ",["$","span",null,{"className":"token keyword","children":"break"}]," ",["$","span",null,{"className":"token comment","children":"// Successfully locked the mutex with CAS."}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token comment","children":"// Sleep and wait for the lock to be released by others."}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token function","children":"runtime_SemacquireMutex"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"sema",["$","span",null,{"className":"token punctuation","children":","}]," queueLifo",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token number","children":"1"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    starving ",["$","span",null,{"className":"token operator","children":"="}]," starving ",["$","span",null,{"className":"token operator","children":"||"}]," ",["$","span",null,{"className":"token function","children":"runtime_nanotime"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token operator","children":"-"}],"waitStartTime ",["$","span",null,{"className":"token operator","children":">"}]," starvationThresholdNs\n"]}],["$","span",null,{"className":"code-line","children":["    old ",["$","span",null,{"className":"token operator","children":"="}]," m",["$","span",null,{"className":"token punctuation","children":"."}],"state ",["$","span",null,{"className":"token comment","children":"// Check the updated state."}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}]]}]}],["$","ul",null,{"children":["$","li",null,{"children":[["$","strong",null,{"children":"Acquiring the Lock"}],": If the goroutine successfully updates the mutex state using the atomic compare-and-swap (CAS) operation, it has acquired the lock. If not, it puts itself to sleep using the semaphore (",["$","code",null,{"children":"runtime_SemacquireMutex()"}],"), waiting for the lock to become available."]}]}],["$","h4",null,{"className":"content-header","id":"purpose-of-mutexwoken","children":[["$","a",null,{"className":"break-words","href":"#purpose-of-mutexwoken","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"Purpose of ",["$","code",null,{"children":"mutexWoken"}]]}],["$","p",null,{"children":["The ",["$","code",null,{"children":"mutexWoken"}]," flag is used in the Go ",["$","code",null,{"children":"sync.Mutex"}]," implementation to manage goroutines waiting to acquire a lock. Its purpose is to ensure that ",["$","strong",null,{"children":"only one waiting goroutine is woken up"}]," when the mutex becomes available. This avoids unnecessary contention and ensures efficient scheduling."]}],["$","p",null,{"children":["When a goroutine attempts to acquire a lock and the lock is already held by another goroutine, the goroutine goes to sleep (or waits), and the ",["$","code",null,{"children":"mutexWoken"}]," flag ensures that the next goroutine in line is properly woken up once the lock is released."]}],["$","h4",null,{"className":"content-header","id":"how-mutexwoken-is-turned-on-and-off","children":[["$","a",null,{"className":"break-words","href":"#how-mutexwoken-is-turned-on-and-off","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"How ",["$","code",null,{"children":"mutexWoken"}]," is Turned On and Off"]}],["$","p",null,{"children":["i. ",["$","strong",null,{"children":["Setting ",["$","code",null,{"children":"mutexWoken"}]," (Turning It On)"]}],": When a goroutine is ",["$","strong",null,{"children":"about to be woken up"}],", the ",["$","code",null,{"children":"mutexWoken"}]," flag is set to notify that this particular goroutine has been woken up. This occurs in the slow path (",["$","code",null,{"children":"lockSlow()"}],"), where the goroutine may go into a waiting queue if the lock is already held."]}],["$","p",null,{"children":"Here's the relevant snippet:"}],["$","$L10",null,{"className":"language-go","children":["$","code",null,{"className":"language-go code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"if"}]," ",["$","span",null,{"className":"token operator","children":"!"}],"awoke ",["$","span",null,{"className":"token operator","children":"&&"}]," old",["$","span",null,{"className":"token operator","children":"&"}],"mutexWoken ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token operator","children":"&&"}]," old",["$","span",null,{"className":"token operator","children":">>"}],"mutexWaiterShift ",["$","span",null,{"className":"token operator","children":"!="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token operator","children":"&&"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    atomic",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"CompareAndSwapInt32"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"state",["$","span",null,{"className":"token punctuation","children":","}]," old",["$","span",null,{"className":"token punctuation","children":","}]," old",["$","span",null,{"className":"token operator","children":"|"}],"mutexWoken",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    awoke ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token boolean","children":"true"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],["$","p",null,{"children":"This part checks:"}],["$","ul",null,{"children":[["$","li",null,{"children":["If the ",["$","code",null,{"children":"awoke"}]," flag is not set yet (i.e., the goroutine hasn’t been woken up yet)."]}],["$","li",null,{"children":["If no other goroutine is already marked as woken (",["$","code",null,{"children":"old & mutexWoken == 0"}],")."]}],["$","li",null,{"children":["If there are goroutines waiting in the queue (",["$","code",null,{"children":"old >> mutexWaiterShift != 0"}],")."]}]]}],["$","p",null,{"children":["If these conditions are met, it atomically sets the ",["$","code",null,{"children":"mutexWoken"}]," flag using ",["$","code",null,{"children":"CompareAndSwapInt32()"}],". This ensures only ",["$","strong",null,{"children":"one"}]," goroutine is woken up at a time to acquire the lock."]}],["$","p",null,{"children":["ii. ",["$","strong",null,{"children":["Checking and Clearing ",["$","code",null,{"children":"mutexWoken"}]," (Turning It Off)"]}],": Once the goroutine has been woken up and is now competing for the lock, the ",["$","code",null,{"children":"mutexWoken"}]," flag needs to be ",["$","strong",null,{"children":"cleared"}]," to allow other waiting goroutines to be woken up in the future."]}],["$","p",null,{"children":"Here's the code snippet:"}],["$","$L10",null,{"className":"language-go","children":["$","code",null,{"className":"language-go code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"if"}]," awoke ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token comment","children":"// The goroutine has been woken from sleep, so we need to reset the flag."}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token keyword","children":"if"}]," ",["$","span",null,{"className":"token builtin","children":"new"}],["$","span",null,{"className":"token operator","children":"&"}],"mutexWoken ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["        ",["$","span",null,{"className":"token function","children":"throw"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"sync: inconsistent mutex state\""}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["    ",["$","span",null,{"className":"token builtin","children":"new"}]," ",["$","span",null,{"className":"token operator","children":"&^="}]," mutexWoken\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],["$","ul",null,{"children":[["$","li",null,{"children":[["$","strong",null,{"children":"Check"}],": First, it checks if the ",["$","code",null,{"children":"mutexWoken"}]," flag is set. If it’s not (",["$","code",null,{"children":"new & mutexWoken == 0"}],"), this indicates an inconsistency because the goroutine believes it was woken up (",["$","code",null,{"children":"awoke"}]," is true), but the flag doesn’t reflect that, so it throws an error (",["$","code",null,{"children":"throw(\"sync: inconsistent mutex state\")"}],")."]}],["$","li",null,{"children":[["$","strong",null,{"children":"Clearing"}],": If everything is consistent, the ",["$","code",null,{"children":"mutexWoken"}]," flag is cleared (",["$","code",null,{"children":"new &^= mutexWoken"}],"). This ensures that future goroutines can be woken up when the lock is released, and no more than one goroutine is woken at a time."]}]]}],["$","h4",null,{"className":"content-header","id":"why-this-mechanism-is-used","children":[["$","a",null,{"className":"break-words","href":"#why-this-mechanism-is-used","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"Why This Mechanism Is Used:"]}],["$","p",null,{"children":["i. ",["$","strong",null,{"children":"Efficiency and Fairness"}],": Only one goroutine should be woken up at a time when a lock is released. Without this mechanism, multiple goroutines might be woken up, causing them to contend for the lock unnecessarily. This can lead to ",["$","strong",null,{"children":"thundering herd problems"}],", where many goroutines wake up and compete for the same lock, leading to inefficiencies. ii. ",["$","strong",null,{"children":"Avoiding Multiple Wakeups"}],": The ",["$","code",null,{"children":"mutexWoken"}]," flag prevents the same goroutine from being woken up multiple times. Once a goroutine has been marked as \"woken up,\" it sets the ",["$","code",null,{"children":"awoke"}]," flag and clears ",["$","code",null,{"children":"mutexWoken"}]," to ensure that other waiting goroutines can be considered for wakeup next. iii. ",["$","strong",null,{"children":"State Consistency"}],": The checks on ",["$","code",null,{"children":"mutexWoken"}]," help ensure that the mutex's internal state remains consistent. If the flag is not set properly (either too early or too late), it indicates a problem with the mutex's state, which could lead to incorrect behavior in multi-goroutine scenarios. This is why there's a strict check that throws an error if the state is inconsistent."]}],["$","h4",null,{"className":"content-header","id":"what-is-starvation-mode","children":[["$","a",null,{"className":"break-words","href":"#what-is-starvation-mode","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"What Is Starvation Mode?"]}],["$","p",null,{"children":[["$","strong",null,{"children":"Starvation mode"}]," is a special state that the mutex can enter when a goroutine has been waiting too long (more than 1 millisecond by default) to acquire the lock. This mode is designed to ensure ",["$","strong",null,{"children":"fairness"}]," by preventing newly arriving goroutines from repeatedly acquiring the lock before older, waiting goroutines, thus avoiding starvation (where a goroutine waits indefinitely for the lock)."]}],["$","h4",null,{"className":"content-header","id":"how-starvation-mode-works","children":[["$","a",null,{"className":"break-words","href":"#how-starvation-mode-works","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"How Starvation Mode Works:"]}],["$","p",null,{"children":["i. ",["$","strong",null,{"children":"Normal Operation"}],":"]}],["$","ul",null,{"children":["$","li",null,{"children":["In normal mode, when a mutex is unlocked, new goroutines that arrive (those trying to acquire the lock) compete with goroutines that are already waiting in line. The new goroutines may have a slight advantage since they are already running and don’t need to be woken up, which could lead to ",["$","strong",null,{"children":"long wait times"}]," for goroutines that have already been waiting."]}]}],["$","p",null,{"children":["ii. ",["$","strong",null,{"children":"Transition to Starvation Mode"}],":"]}],["$","ul",null,{"children":[["$","li",null,{"children":["$","p",null,{"children":["When a goroutine has been waiting for ",["$","strong",null,{"children":"longer than a predefined threshold"}]," (1 millisecond by default), it sets the mutex to ",["$","strong",null,{"children":"starvation mode"}],". This is indicated by the ",["$","code",null,{"children":"mutexStarving"}]," bit in the ",["$","code",null,{"children":"mutex.state"}],"."]}]}],["$","li",null,{"children":["$","p",null,{"children":["Once in starvation mode, newly arriving goroutines are ",["$","strong",null,{"children":"no longer allowed to acquire the lock"}],". The lock is handed directly to the goroutine that has been waiting the longest (the one at the front of the queue). This ensures that waiting goroutines are prioritized over new arrivals."]}]}]]}],["$","p",null,{"children":["iii. ",["$","strong",null,{"children":"Mutex Ownership Hand-off"}],":"]}],["$","ul",null,{"children":[["$","li",null,{"children":["$","p",null,{"children":["In starvation mode, when the mutex is unlocked, ",["$","strong",null,{"children":"ownership"}]," of the mutex is ",["$","strong",null,{"children":"immediately transferred"}]," to the first waiting goroutine, bypassing the normal competition with new goroutines."]}]}],["$","li",null,{"children":["$","p",null,{"children":["Newly arriving goroutines are added to the ",["$","strong",null,{"children":"back of the queue"}]," and do not compete for the lock while the mutex is in starvation mode."]}]}]]}],["$","p",null,{"children":["iv. ",["$","strong",null,{"children":"Exiting Starvation Mode"}],":"]}],["$","ul",null,{"children":[["$","li",null,{"children":["The mutex exits starvation mode when a goroutine successfully acquires the lock, and either:",["$","ul",null,{"children":[["$","li",null,{"children":"It was the last goroutine in the wait queue."}],["$","li",null,{"children":"It waited for less than 1 millisecond."}]]}]]}],["$","li",null,{"children":"This allows the system to return to normal operation mode (with FIFO-style queueing), balancing performance and fairness."}]]}],["$","h3",null,{"className":"content-header","id":"6-system-calls-and-blocking","children":[["$","a",null,{"className":"break-words","href":"#6-system-calls-and-blocking","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"6. ",["$","strong",null,{"children":"System Calls and Blocking"}]]}],["$","p",null,{"children":["If the lock is held for a long time, the goroutine might block (via the ",["$","code",null,{"children":"runtime_SemacquireMutex()"}]," function), and the Go runtime will coordinate with the OS to put the goroutine to sleep. When the lock becomes available, the OS will wake the goroutine up, and it will retry locking."]}],["$","h3",null,{"className":"content-header","id":"7-unlocking-mutexunlock","children":[["$","a",null,{"className":"break-words","href":"#7-unlocking-mutexunlock","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"7. ",["$","strong",null,{"children":["Unlocking (",["$","code",null,{"children":"mutex.Unlock()"}],")"]}]]}],["$","p",null,{"children":["When ",["$","code",null,{"children":"mutex.Unlock()"}]," is called, it does the reverse:"]}],["$","$L10",null,{"className":"language-go","children":["$","code",null,{"className":"language-go code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token comment","children":"// Unlock unlocks m."}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token comment","children":"// It is a run-time error if m is not locked on entry to Unlock."}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token comment","children":"//"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token comment","children":"// A locked [Mutex] is not associated with a particular goroutine."}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token comment","children":"// It is allowed for one goroutine to lock a Mutex and then"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token comment","children":"// arrange for another goroutine to unlock it."}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"func"}]," ",["$","span",null,{"className":"token punctuation","children":"("}],"m ",["$","span",null,{"className":"token operator","children":"*"}],"Mutex",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token function","children":"Unlock"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token keyword","children":"if"}]," race",["$","span",null,{"className":"token punctuation","children":"."}],"Enabled ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token boolean","children":"_"}]," ",["$","span",null,{"className":"token operator","children":"="}]," m",["$","span",null,{"className":"token punctuation","children":"."}],"state\n"]}],["$","span",null,{"className":"code-line","children":["\t\trace",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"Release"}],["$","span",null,{"className":"token punctuation","children":"("}],"unsafe",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"Pointer"}],["$","span",null,{"className":"token punctuation","children":"("}],"m",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":"\n"}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token comment","children":"// Fast path: drop lock bit."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token builtin","children":"new"}]," ",["$","span",null,{"className":"token operator","children":":="}]," atomic",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"AddInt32"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"state",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token operator","children":"-"}],"mutexLocked",["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token keyword","children":"if"}]," ",["$","span",null,{"className":"token builtin","children":"new"}]," ",["$","span",null,{"className":"token operator","children":"!="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// Outlined slow path to allow inlining the fast path."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// To hide unlockSlow during tracing we skip one extra frame when tracing GoUnblock."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\tm",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"unlockSlow"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token builtin","children":"new"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],["$","ul",null,{"children":[["$","li",null,{"children":[["$","strong",null,{"children":"Atomic Subtraction"}],": The unlock operation decrements the lock state (",["$","code",null,{"children":"m.state"}],"), marking the mutex as unlocked."]}],["$","li",null,{"children":[["$","strong",null,{"children":"Semaphore Release"}],": If there are other goroutines waiting (",["$","code",null,{"children":"new != 0"}],"), the ",["$","code",null,{"children":"runtime_Semrelease()"}]," function is called to wake them up and let them retry locking."]}],["$","li",null,{"children":["$","strong",null,{"children":"Slow Path Unlock"}]}]]}],["$","$L10",null,{"className":"language-go","children":["$","code",null,{"className":"language-go code-highlight","children":[["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token keyword","children":"func"}]," ",["$","span",null,{"className":"token punctuation","children":"("}],"m ",["$","span",null,{"className":"token operator","children":"*"}],"Mutex",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token function","children":"unlockSlow"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token builtin","children":"new"}]," ",["$","span",null,{"className":"token builtin","children":"int32"}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token keyword","children":"if"}]," ",["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token builtin","children":"new"}],["$","span",null,{"className":"token operator","children":"+"}],"mutexLocked",["$","span",null,{"className":"token punctuation","children":")"}],["$","span",null,{"className":"token operator","children":"&"}],"mutexLocked ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token function","children":"fatal"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token string","children":"\"sync: unlock of unlocked mutex\""}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token keyword","children":"if"}]," ",["$","span",null,{"className":"token builtin","children":"new"}],["$","span",null,{"className":"token operator","children":"&"}],"mutexStarving ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\told ",["$","span",null,{"className":"token operator","children":":="}]," ",["$","span",null,{"className":"token builtin","children":"new"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token keyword","children":"for"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token comment","children":"// If there are no waiters or a goroutine has already"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token comment","children":"// been woken or grabbed the lock, no need to wake anyone."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token comment","children":"// In starvation mode ownership is directly handed off from unlocking"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token comment","children":"// goroutine to the next waiter. We are not part of this chain,"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token comment","children":"// since we did not observe mutexStarving when we unlocked the mutex above."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token comment","children":"// So get off the way."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," old",["$","span",null,{"className":"token operator","children":">>"}],"mutexWaiterShift ",["$","span",null,{"className":"token operator","children":"=="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token operator","children":"||"}]," old",["$","span",null,{"className":"token operator","children":"&"}],["$","span",null,{"className":"token punctuation","children":"("}],"mutexLocked",["$","span",null,{"className":"token operator","children":"|"}],"mutexWoken",["$","span",null,{"className":"token operator","children":"|"}],"mutexStarving",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"!="}]," ",["$","span",null,{"className":"token number","children":"0"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token keyword","children":"return"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token comment","children":"// Grab the right to wake someone."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token builtin","children":"new"}]," ",["$","span",null,{"className":"token operator","children":"="}]," ",["$","span",null,{"className":"token punctuation","children":"("}],"old ",["$","span",null,{"className":"token operator","children":"-"}]," ",["$","span",null,{"className":"token number","children":"1"}],["$","span",null,{"className":"token operator","children":"<<"}],"mutexWaiterShift",["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token operator","children":"|"}]," mutexWoken\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token keyword","children":"if"}]," atomic",["$","span",null,{"className":"token punctuation","children":"."}],["$","span",null,{"className":"token function","children":"CompareAndSwapInt32"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"state",["$","span",null,{"className":"token punctuation","children":","}]," old",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token builtin","children":"new"}],["$","span",null,{"className":"token punctuation","children":")"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token function","children":"runtime_Semrelease"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"sema",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token boolean","children":"false"}],["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token number","children":"1"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t\t",["$","span",null,{"className":"token keyword","children":"return"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t\told ",["$","span",null,{"className":"token operator","children":"="}]," m",["$","span",null,{"className":"token punctuation","children":"."}],"state\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token punctuation","children":"}"}]," ",["$","span",null,{"className":"token keyword","children":"else"}]," ",["$","span",null,{"className":"token punctuation","children":"{"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// Starving mode: handoff mutex ownership to the next waiter, and yield"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// our time slice so that the next waiter can start to run immediately."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// Note: mutexLocked is not set, the waiter will set it after wakeup."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// But mutex is still considered locked if mutexStarving is set,"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token comment","children":"// so new coming goroutines won't acquire it."}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t\t",["$","span",null,{"className":"token function","children":"runtime_Semrelease"}],["$","span",null,{"className":"token punctuation","children":"("}],["$","span",null,{"className":"token operator","children":"&"}],"m",["$","span",null,{"className":"token punctuation","children":"."}],"sema",["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token boolean","children":"true"}],["$","span",null,{"className":"token punctuation","children":","}]," ",["$","span",null,{"className":"token number","children":"1"}],["$","span",null,{"className":"token punctuation","children":")"}],"\n"]}],["$","span",null,{"className":"code-line","children":["\t",["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}],["$","span",null,{"className":"code-line","children":[["$","span",null,{"className":"token punctuation","children":"}"}],"\n"]}]]}]}],["$","h3",null,{"className":"content-header","id":"8-memory-barriers","children":[["$","a",null,{"className":"break-words","href":"#8-memory-barriers","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"8. ",["$","strong",null,{"children":"Memory Barriers"}]]}],["$","p",null,{"children":["Memory barriers are automatically handled by the atomic operations (",["$","code",null,{"children":"atomic.CompareAndSwapInt32()"}]," and ",["$","code",null,{"children":"atomic.AddInt32()"}],") in Go. These barriers ensure proper memory visibility between goroutines, so changes made before the mutex is unlocked are visible to other goroutines after they acquire the lock."]}],["$","h3",null,{"className":"content-header","id":"summary-of-the-mutex-lock-mechanism-in-go","children":[["$","a",null,{"className":"break-words","href":"#summary-of-the-mutex-lock-mechanism-in-go","aria-hidden":"true","tabIndex":"-1","children":["$","span",null,{"className":"content-header-link","children":["$","svg",null,{"className":"h-5 linkicon w-5","fill":"currentColor","viewBox":"0 0 20 20","xmlns":"http://www.w3.org/2000/svg","children":[["$","path",null,{"d":"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"}],["$","path",null,{"d":"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"}]]}]}]}],"Summary of the Mutex Lock Mechanism in Go:"]}],["$","ol",null,{"children":[["$","li",null,{"children":[["$","strong",null,{"children":"Fast Path (CAS)"}],": Tries to acquire the lock using atomic compare-and-swap (CAS) in user space."]}],["$","li",null,{"children":[["$","strong",null,{"children":"Slow Path"}],": If the lock is already held, the goroutine might either spin (recheck lock) or block (sleep), using semaphores for synchronization."]}],["$","li",null,{"children":[["$","strong",null,{"children":"System Calls"}],": If the slow path is taken and the lock is unavailable, the Go runtime uses system calls to put the goroutine to sleep and wake it when the lock is free."]}],["$","li",null,{"children":[["$","strong",null,{"children":"Unlocking"}],": On unlocking, the lock state is atomically modified, and waiting goroutines (if any) are woken up using semaphore-like mechanisms."]}]]}],["$","p",null,{"children":"This lock mechanism balances efficiency (by avoiding system calls with CAS) and fairness (by eventually blocking goroutines to avoid CPU wastage)."}]]}]}],["$","footer",null,{"children":[["$","div",null,{"className":"divide-gray-200 text-sm font-medium leading-5 dark:divide-gray-700 xl:col-start-1 xl:row-start-2 xl:divide-y","children":[["$","div",null,{"className":"py-4 xl:py-8","children":[["$","h2",null,{"className":"text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400","children":"Tags"}],["$","div",null,{"className":"flex flex-wrap","children":[["$","$L9",null,{"href":"/tags/programming-basic","className":"mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400","children":"programming-basic"}],["$","$L9",null,{"href":"/tags/programming-languages","className":"mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400","children":"programming-languages"}],["$","$L9",null,{"href":"/tags/go","className":"mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400","children":"go"}]]}]]}],["$","div",null,{"className":"flex justify-between py-4 xl:block xl:space-y-8 xl:py-8","children":[["$","div",null,{"children":[["$","h2",null,{"className":"text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400","children":"Previous Article"}],["$","div",null,{"className":"text-primary-500 hover:text-primary-600 dark:hover:text-primary-400","children":["$","$L9",null,{"className":"break-words","href":"/blog/programming-basic/programming-languages/go/race-detector","children":"Race Detector in Go"}]}]]}],["$","div",null,{"children":[["$","h2",null,{"className":"text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400","children":"Next Article"}],["$","div",null,{"className":"text-primary-500 hover:text-primary-600 dark:hover:text-primary-400","children":["$","$L9",null,{"className":"break-words","href":"/blog/programming-basic/programming-languages/go/go-basic","children":"Go Basic"}]}]]}]]}]]}],["$","div",null,{"className":"pt-4 xl:pt-8","children":["$","$L9",null,{"className":"text-primary-500 hover:text-primary-600 dark:hover:text-primary-400","href":"/blog","aria-label":"Back to the projects","children":"← Back to the projects"}]}]]}]]}]]}]}]]}]]
d:[["$","meta","0",{"name":"viewport","content":"width=device-width, initial-scale=1"}],["$","meta","1",{"charSet":"utf-8"}],["$","title","2",{"children":"Mutex in Go | CodeWisdom"}],["$","meta","3",{"name":"description","content":"Explores the mutex in Go."}],["$","meta","4",{"name":"robots","content":"index, follow"}],["$","meta","5",{"name":"googlebot","content":"index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1"}],["$","link","6",{"rel":"canonical","href":"https://codewisdom.io/blog/programming-basic/programming-languages/go/mutex"}],["$","link","7",{"rel":"alternate","type":"application/rss+xml","href":"https://codewisdom.io/feed.xml"}],["$","meta","8",{"property":"og:title","content":"Mutex in Go"}],["$","meta","9",{"property":"og:description","content":"Explores the mutex in Go."}],["$","meta","10",{"property":"og:url","content":"https://codewisdom.io/blog/programming-basic/programming-languages/go/mutex"}],["$","meta","11",{"property":"og:site_name","content":"CodeWisdom"}],["$","meta","12",{"property":"og:locale","content":"en_US"}],["$","meta","13",{"property":"og:image","content":"https://codewisdom.io/static/images/logo-round.png"}],["$","meta","14",{"property":"og:type","content":"article"}],["$","meta","15",{"property":"article:published_time","content":"2024-10-31T00:00:00.000Z"}],["$","meta","16",{"property":"article:modified_time","content":"2024-10-31T00:00:00.000Z"}],["$","meta","17",{"property":"article:author","content":"Bowen Y"}],["$","meta","18",{"name":"twitter:card","content":"summary_large_image"}],["$","meta","19",{"name":"twitter:title","content":"Mutex in Go"}],["$","meta","20",{"name":"twitter:description","content":"Explores the mutex in Go."}],["$","meta","21",{"name":"twitter:image","content":"https://codewisdom.io/static/images/logo-round.png"}],["$","meta","22",{"name":"next-size-adjust"}]]
1:null
